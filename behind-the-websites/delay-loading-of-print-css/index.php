<?php
$year = '2010';
$slug = 'delay-loading-of-print-css bxP-id689 bxPC-behind-the-websites bxPTag-coding bxPTag-css bxPTag-javascript bxPTag-wordpress bxPA-peter"><div id="pageWrap" class="brt"><div id="header"><div id="siteDetails"><p id="siteName"><a href="http://bigredtin.com"><img src="/wp-content/themes/bigredtin/assets/child/i/logo-white-24.png" class="screen" width="323" height="90" alt="Big Red Tin  | Thoughts about the web and business from the large pantry" title="Big Red Tin | Thoughts about the web and business from the large pantry" /><img src="/wp-content/themes/bigredtin/assets/child/i/logo-colour-24.png" class="print" width="323" height="90" alt="" title="" /></a></p></div><div id="headerWidgets"></div></div><div id="container"><div id="navWrap" class="navWrap"></div><div id="content"><div id="contentHeadA" class="hentry p1 post publish post-delay-loading-of-print-css author-peter-wilson cat-behind-the-websites tagged tag-coding tag-css tag-javascript tag-wordpress"><div id="contentHead"><h1 class="entry-title" id="pageName"> <a href="/behind-the-websites/delay-loading-of-print-css/" title="Delay loading of print CSS" rel="bookmark"> Delay loading of print CSS </a></h1><p class="entry-date"><span class="published" title="2010-07-28T15:03:50+00:00">28 Jul '10</span></p></div><div id="contentA"><div class="entry-meta"><p class="details"> <span class="author vcard">By <a class="url fn n" href="/author/peter/" title="View all posts by Peter Wilson">Peter Wilson</a></span> <span class="cat-links"> in <a href="/behind-the-websites/" title="View all posts in Behind the Websites" rel="category tag">Behind the Websites</a></span></p><p class="comments-link"> <a href="/behind-the-websites/delay-loading-of-print-css/#comments">No responses</a></p></div><div class="entry-content"><p>Recently I stumbled across an article on zOompf <a title="detailing browser performance with the CSS print media type" href="http://zoompf.com/blog/2009/12/browser-performance-problem-with-css-print-media-type" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','zoompf.com/blog/2009/12/browser-performance-problem-with-css-print-media-type']);">detailing browser performance with the CSS print media type</a>. In most recent browsers, Safari being the exception, the print stylesheet held up rendering of the page.</p><p>The zOomph article suggests a solution, to load print stylesheets using JavaScript once the page has  rendered (ie, on the <code>window.onload</code> event), with a backup for the JavaScript impaired. You can see their code in the original article.</p><h4>Automating the task for WordPress</h4><p>Most sites I develop are in WordPress so I decided to automate the process. This relies on using <code>wp_enqueue_style</code> to register the stylesheets:</p><pre><code>function enqueue_css(){   if (!is_admin()){     wp_enqueue_style (       'bigred-print', /* handle */       '/path-to/print.css', /* source */       null, /* no requirements */       '1.0', /* version */       'print' /* media type */     );   } } add_action('wp_print_styles', 'enqueue_css');</code></pre><p>The above code will output the following HTML in the header:</p><pre><code>&lt;link rel='stylesheet' id='bigred-print-css'  href='/path-to/print.css?ver=1.0' type='text/css' media='print' /&gt;</code></pre><p>The first step is to wrap the above html in noscript tags, the WordPress <a title="filter" href="http://codex.wordpress.org/Plugin_API#Filters" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','codex.wordpress.org/Plugin_API#Filters']);">filter</a> <code>style_loader_tag</code> is ideal for this.</p><pre><code>function js_printcss($tag, $handle) {   global $wp_styles;   if ($wp_styles-&gt;registered[$handle]-&gt;args == 'print') {     $tag = "&lt;noscript&gt;" . $tag . "&lt;/noscript&gt;";   }   return $tag; } add_filter('style_loader_tag', 'js_printcss', 5, 2);</code></pre><p>The filter runs for all stylesheets, regardless of media type, so the function checks for print stylesheets and wraps them in the <code>noscript</code> tag, other media types are left alone.</p><p>The first two arguments are the filter and function names respectively, the third argument specifies the timing (5 is the default) and the final argument tells WordPress how many arguments to pass to the filter – two – in this case $tag and $handle.</p><p>With the new filter, WordPress now outputs following HTML in the header:</p><pre><code>&lt;noscript&gt; &lt;link rel='stylesheet' id='bigred-print-css'  href='/path-to/print.css?ver=1' type='text/css' media='print' /&gt; &lt;/noscript&gt;</code></pre><p>The next step is to add the JavaScript to load the stylesheets, we can do this by changing our original function, <code>js_printcss</code>, and making use of a global variable:</p><pre><code>$printCSS = '';  function js_printcss($tag, $handle){   global $wp_styles, $printCSS;   if ($wp_styles-&gt;registered[$handle]-&gt;args == 'print') {      $tag = "&lt;noscript&gt;" . $tag . "&lt;/noscript&gt;";      preg_match("/&lt;\s*link\s+[^&gt;]*href\s*=\s*[\"']?([^\"' &gt;]+)[\"' &gt;]/", $tag, $hrefArray);     $href = $hrefArray[1];      $printCSS .= "var cssNode = document.createElement('link');";     $printCSS .= "cssNode.type = 'text/css';";     $printCSS .= "cssNode.rel = 'stylesheet';";     $printCSS .= "cssNode.href = '" . esc_js($href) . "';";     $printCSS .= "cssNode.media = 'print';";     $printCSS .= "document.getElementsByTagName(\"head\")[0].appendChild(cssNode);";   }   return $tag; }</code></pre><p>The code creates the PHP variable <code>$printCSS</code> globally, which is then called into the function using the global command.</p><p>After wrapping the tag in the <code>noscript</code> tags, the new function uses a regular expression to extract the URL of the stylesheet from the link tag and placing it the variable <code>$href</code>.</p><p>Having extracted the stylesheet&#8217;s URL, the function then appends the required JavaScript to the PHP global variable <code>$printCSS</code>.</p><p>The final step is to add the JavaScript to the footer of the HTML using the wp_footer action in WordPress. The PHP to do this is:</p><pre><code>function printCSS_scriptTags(){   global $printCSS;   if ($printCSS != '') {     echo "&lt;script type='text/javascript'&gt;\n";     echo "window.onload = function(){\n";     echo $printCSS;     echo "}\n&lt;/script&gt;";   } }  add_action('wp_footer', 'printCSS_scriptTags');</code></pre><p>The above code uses <code>window.onload</code> as dictated in the original article. A better method would be to use an event listener to do the work, for those using jQuery we would change the function to:</p><pre><code>function printCSS_scriptTags(){   global $printCSS;   if ($printCSS != '') {     echo "&lt;script type='text/javascript'&gt;\n";     echo "jQuery(window).ready(function(){\n";     echo $printCSS;     echo "});\n&lt;/script&gt;";  }  } add_action('wp_footer', 'printCSS_scriptTags');</code></pre><p>The above solution had been tested for very limited circumstances only and found to have worked. Were I to use the function in a production environment I would undertake further testing.</p><p>Another question to ask is whether all this is actually worth the effort – even when reduced through automation. On Big Red Tin, the print.css is 595 bytes, the delay in rendering is negligible.</p><p><strong>Update Aug 23, 2010</strong>: Fixed a type in the code block redefining <code>js_printcss</code>.</p><p><strong>Update Aug 27, 2010</strong>: I&#8217;ve decided to release this as a plugin, get the skinny and the plugin from the <a href="/behind-the-websites/delay-print-css-plugin/" >followup article</a>.</p></div><p class="tag-links entry-meta">Tagged: <a href="/tag/coding/" rel="tag">coding</a> &bull; <a href="/tag/css/" rel="tag">CSS</a> &bull; <a href="/tag/javascript/" rel="tag">JavaScript</a> &bull; <a href="/tag/wordpress/" rel="tag">WordPress</a></p><div id="authorDescription" class="author-description vcard"> <img alt='' src='http://1.gravatar.com/avatar/d6fa5fdcd09cd9484ebca5c0844cc13b?s=96&amp;d=http%3A%2F%2Fbigredtin.com%2Fwp-includes%2Fimages%2Fblank.gif&amp;r=G' class='avatar avatar-96 photo' height='96' width='96' /><h2>About<cite class="fn"> Peter Wilson</cite></h2><p>Peter Wilson is a Web Developer based in Melbourne, Australia. He co-founded Web Production firm <a href="http://soupgiant.com/" title="Soupgiant">Soupgiant</a> with Josh Kinal in October 2009.</p></div><div id="page-nav" class="page-nav nav"><div class="page-nav-older"><span class="direction">Previous post: </span><a href="/behind-the-websites/thesis-v-wordpress/" rel="prev">Thesis V WordPress, Pearson V Mullenweg</a></div><div class="page-nav-newer"><span class="direction">Next post: </span><a href="/design/use-experience-to-build-experience/" rel="next">Use Experience to build Experience</a></div></div><div id="comments"><div id="respond"><h2>Leave a Reply</h2><div id="cancel-comment-reply"><a rel="nofollow" id="cancel-comment-reply-link" href="/behind-the-websites/delay-loading-of-print-css/#respond" style="display:none;">Click here to cancel reply.</a></div><div class="formContainer"><form id="commentForm" action="/wp-comments-post.php" method="post"><p id="commentNotes">Your email is <em>never</em> shared.</p><div id="namePair" class="inputPair"> <label for="author">Name <span class="required">(required)</span></label> <input id="author" name="author" class="inputText inputReqd inputTextReqd" type="text" value="" size="30" maxlength="50" tabindex="3" /></div><div id="emailPair" class="inputPair"> <label for="email">Email <span class="required">(required)</span></label> <input id="email" name="email" class="inputText inputEmail inputReqd inputTextreqd inputEmailreqd" type="email" value="" size="30" maxlength="50" tabindex="4" /></div><div id="urlPair" class="inputPair"> <label for="url">Website</label> <input id="url" name="url" class="inputText" type="url" value="" size="30" maxlength="50" tabindex="5" /></div><div id="commentPair" class="inputPair"> <label for="comment">Comment <span class="required">(required)</span></label><textarea id="comment" name="comment" class="inputText inputReqd inputTextReqd" cols="45" rows="8" tabindex="6"></textarea></div><div class="submit"> <input id="submit" name="submit" class="button" type="submit" value="Post Your Comment" tabindex="7" /></div><div class="form-option"><input type='hidden' name='comment_post_ID' value='689' id='comment_post_ID' /> <input type='hidden' name='comment_parent' id='comment_parent' value='0' /></div></form></div></div></div></div></div></div><div id="contentC" class="sidebar"><div id="search-3" class="widget widget_search"><form method="get" action="http://bigredtin.com" class="search-form"><div> <label for="s-93323" class="search-label">Search this Site</label> <input type="text" name="s" id="s-93323" class="searchInput inputText" /> <input type="submit" value="Search" class="searchSubmit inputSubmit" /></div></form></div><div id="twitter-tools" class="widget aktt_widget"><h5 class="widget-title">Tasty Tweets</h5><div class="aktt_tweets"><ul><li>Looking @ <a href="http://ie6countdown.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','ie6countdown.com/']);" rel="nofollow">http://ie6countdown.com/</a> in IE6, @<a href="http://twitter.com/Microsoft" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','twitter.com/Microsoft']);" class="aktt_username">Microsoft</a>&#039;s point would be better made with degraded CSS3, etc ^pw <a href="http://twitter.com/bigredtin/statuses/44542947458416640" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','twitter.com/bigredtin/statuses/44542947458416640']);" class="aktt_tweet_time">1 week ago</a></li><li>RT @<a href="http://twitter.com/Microsoft" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','twitter.com/Microsoft']);" class="aktt_username">Microsoft</a>: It&#039;s not often that we encourage u to stop using one of our products, but 4 #<a href="http://search.twitter.com/search?q=%23IE6" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','search.twitter.com/search?q=%23IE6']);" class="aktt_hashtag">IE6</a> we&#039;ll make exception: <a href="http://bit.ly/g0wt4m" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','bit.ly/g0wt4m']);" rel="nofollow">http://bit.ly/g0wt4m</a> <a href="http://twitter.com/bigredtin/statuses/43830419589828608" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','twitter.com/bigredtin/statuses/43830419589828608']);" class="aktt_tweet_time">2 weeks ago</a></li><li>RT @<a href="http://twitter.com/brucel" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','twitter.com/brucel']);" class="aktt_username">brucel</a>: <a href="http://www.ie6countdown.com" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','www.ie6countdown.com']);" rel="nofollow">http://www.ie6countdown.com</a> if opera can make a browser supporting modern standards that works on [win2k], surely [MS] can backport ie9 <a href="http://twitter.com/bigredtin/statuses/43823981454835712" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','twitter.com/bigredtin/statuses/43823981454835712']);" class="aktt_tweet_time">2 weeks ago</a></li><li class="aktt_more_updates"><a href="http://twitter.com/bigredtin">More updates...</a></li></ul></div></div><div id="text-4" class="widget widget_text"><h5 class="widget-title">B.R.T. by Soupgiant</h5><div class="textwidget"><p>Big Red Tin is presented by <a href="http://soupgiant.com" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','soupgiant.com']);"><strong>Soupgiant</strong></a>.</p><p>The philosophy is simple: <strong>Good content presented in the most efficient, user-friendly and accessible way possible</strong>.</p></div></div></div></div><div id="footer"><div id="footWidgets"><div id="recent-posts-3" class="foot-widget widget widget_recent_entries"><h5 class="widget-title">Recent Posts</h5><ul><li><a href="/quick-notes/guest-post-on-digwp/" title="Guest Post on Digging into WordPress">Guest Post on Digging into WordPress</a></li><li><a href="/design/details-prevent-user-paralysis/" title="Details Prevent User Paralysis">Details Prevent User Paralysis</a></li><li><a href="/quick-notes/caching-google-webfont-loader/" title="Caching Google&#8217;s WebFont Loader">Caching Google&#8217;s WebFont Loader</a></li><li><a href="/quick-notes/soupgiant-wordpress-themes-github/" title="Soupgiant WordPress themes on Github">Soupgiant WordPress themes on Github</a></li><li><a href="/behind-the-websites/html5-couldnt-do-it/" title="HTML5: I couldn&#8217;t (quite) do it">HTML5: I couldn&#8217;t (quite) do it</a></li></ul></div><div id="categories-3" class="foot-widget widget widget_categories"><h5 class="widget-title">Categories</h5><ul><li class="cat-item cat-item-557"><a href="/behind-the-websites/" title="Everything to do with website coding that we can think of. Front-end, back-end, upside and down, you&#039;ll find it here. It also contains our thoughts about Content Management Systems (CMS) and all the other little and technical things.">Behind the Websites</a></li><li class="cat-item cat-item-31"><a href="/business/" title="Producing websites is, in itself a business, but it often relates to the business of our clients. We&#039;ll try to put all of those thoughts and processes in here.">Business</a></li><li class="cat-item cat-item-540"><a href="/content-strategy/" title="Content whosawhatnow? When producing websites it&#039;s really important to think about what information you&#039;re going to provide, how it&#039;s going to be displayed and how is it going to affect your audience. That&#039;s content strategy in a nutshell. This is where we crack that nut.">Content Strategy</a></li><li class="cat-item cat-item-54"><a href="/design/" title="Design is so much more than just the graphics. A lot of thought goes in to how something looks, where elements are placed, what does and doesn&#039;t appear and when. You&#039;ll find that information here.">Design</a></li><li class="cat-item cat-item-4574"><a href="/quick-notes/" title="Just like it sounds. This is where we post clippings of interesting things we&#039;ve found (code, opinions, writings, pictures) that deal with all aspects of making the web. We found them interesting. You don&#039;t have to.">Quick Notes</a></li></ul></div><div id="linkcat-530" class="foot-widget widget widget_links"><h5 class="widget-title">Handy Links</h5><ul class='xoxo blogroll'><li><a href="/about/" rel="me" title="About Big Red Tin">About Big Red Tin</a></li><li><a href="http://twitter.com/bigredtin" rel="me" title="Follow Big Red Tin on Twitter" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://twitter.com/bigredtin']);">Follow us on Twitter</a></li><li><a href="/contact" rel="me" title="Get in Contact">Get in Contact</a></li><li><a href="http://feeds.soupgiant.com/bigredtin" rel="me" title="Subscribe to Big Red Tin in your feed reader" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://feeds.soupgiant.com/bigredtin']);">Subscribe by RSS</a></li><li><a href="/plugins-themes/" rel="me">WordPress Plugins &amp; Themes</a></li></ul></div><div id="text-3" class="foot-widget widget widget_text"><h5 class="widget-title">Side Credits</h5><div class="textwidget"><ul><li class="copyright">Copyright &copy; 2009 - 2010 <a href="http://soupgiant.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','soupgiant.com/']);">Soupgiant</a></li><li class="credits credits-dev">Developed by <a href="http://soupgiant.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','soupgiant.com/']);">Soupgiant</a></li><li class="credits credits-design">Design by <a href="http://zepol.com.au/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','zepol.com.au/']);">Zepol</a></li><li class="powered">Inevitably powered by <a href="http://wordpress.org" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','wordpress.org']);">WordPress</a></li></ul></div></div></div></div></div>  <script type='text/javascript'>try{jQuery.noConflict();}catch(e){};</script> <script type='text/javascript' src='/wp-content/themes/soup02/assets/parent/j/sg-base-min.js?ver=1.1.0'></script> <script type='text/javascript' src='/wp-content/themes/bigredtin/assets/child/j/custom-min.js?ver=1.0.0'></script> <script type='text/javascript' src='/wp-content/plugins/contact-form-7/jquery.form.js?ver=2.47'></script> <script type='text/javascript' src='/wp-content/plugins/contact-form-7/scripts.js?ver=2.4.2'></script> <script src="https://stats.wordpress.com/e-201111.js" type="text/javascript"></script> <script type="text/javascript">st_go({blog:'13871010',v:'ext',post:'689'});var load_cmc=function(){linktracker_init(13871010,689,2);};if(typeof addLoadEvent!='undefined')addLoadEvent(load_cmc);else load_cmc();</script> <!--[if IE 6]> <script type='text/javascript' src='/wp-content/themes/soup02/assets/parent/j/ddbelatedpng-min.js'></script> <script type="text/javascript">if(typeof jQuery=="function"){jQuery(window).ready(function(){DD_belatedPNG.fix('img');});}else{DD_belatedPNG.fix('img');}</script> <![endif]--></body></html>  <!-- Performance optimized by W3 Total Cache. Learn more: http://www.w3-edge.com/wordpress-plugins/    Minified using disk  Page Caching using disk (enhanced)  Content Delivery Network via assets.sgiant.com/pressgiant    Served from: bigredtin.com @ 2011-03-19 07:21:34 -->